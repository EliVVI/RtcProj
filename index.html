<html>
	<head>
		<title>WebRTCTest</title>
		<script type="text/javascript" src="/adapter.js"></script>
		<script type="text/javascript" src="http://localhost:8888/socket.io/lib/socket.io.js"></script>
		<script>
			//Список ICE серверов
			var rtcConfig = {
				iceServers : [
					{url : "stun:stun.l.google.com:19302"},
					{url : "stun:stun1.l.google.com:19302"},
					{url : "stun:stun2.l.google.com:19302"},
					{url : "stun:stun3.l.google.com:19302"},
					{url : "stun:stun4.l.google.com:19302"}
				]
			};
			
			//Создали RTCPeerConnection объект. Данная ф-я - фасад из adapter.js
			var peerConnection = new RTCPeerConnection(rtcConfig);
			
			console.log("create peerConnection");
			console.log(peerConnection);
			
			//Пулл RTCPeer соединений 
			var __webRtcConnectionsPool = {};
			
			//Текущий ID клиента
			var __clientID = "";
			
			//Открываем сокет соединение
			var socket = io.connect("http://127.0.0.1:8888");
			
			//Обработчик на событие установленного соединения
			socket.on('handshake', function(data){
				//Устанавливаем идентификатор клиента
				if(__clientID === "")
					__clientID = data.guid;
				
				console.log(data);
				console.log(__clientID);
			});
			
			socket.on("takeRemoteSdp", function(data){
				var data = JSON.parse(data);
				if(data.sdp){
					peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp), function(){
						if(peerConnection.remoteDescription.type === "offer"){
							//Получили SDP, значит надо отправить ответ
							peerConnection.createAnswer(createOfferAnswerCallback, logError);
						}
					}, logError);
				}
			});
			
			//Отправляем SDP через сокет соединение
			function sendSdpOthers(socket, peerConnection){
				socket.emit("takeSDP", JSON.stringify({"sdp" : peerConnection.localDescription}));
			}
			
			//Отправляем оффер
			peerConnection.createOffer(createOfferAnswerCallback, logError);
			
			//Колбэк на отправку оффера/ответа
			function createOfferAnswerCallback(offerSDP){
				//Сначала устанавливаем локальные настройки канала
				peerConnection.setLocalDescription(offerSDP, function(){
					console.log("create offer and set local desciption");
					console.log(peerConnection.localDescription);
					
					//А вот здесь отправляем другому браузеру наши настройки
					sendSdpOthers(socket, peerConnection);
				}, logError);
			}
			
			function logError(error){
				console.log(error.name + ": " + error.message);
			}
		</script>
	</head>
	<body>
		index page
	</body>
</html>