<html>
	<head>
		<title>WebRTCTest</title>
		<script type="text/javascript" src="/adapter.js"></script>
		<script type="text/javascript" src="http://localhost:8888/socket.io/lib/socket.io.js"></script>
		<script>
			//Список ICE серверов
			var rtcConfig = {
				iceServers : [
					{url : "stun:stun.l.google.com:19302"},
					{url : "stun:stun1.l.google.com:19302"},
					{url : "stun:stun2.l.google.com:19302"},
					{url : "stun:stun3.l.google.com:19302"},
					{url : "stun:stun4.l.google.com:19302"}
				]
			};
			
			//Создали RTCPeerConnection объект. Данная ф-я - фасад из adapter.js
			var peerConnection = new RTCPeerConnection(rtcConfig);
			
			//Пул RTCPeer соединений 
			var __webRtcConnectionsPool = {};
			
			//Текущий ID клиента
			var __clientID = "";
			
			//Открываем сокет соединение
			var socket = io.connect("http://127.0.0.1:8888");
			
			//Функция заполняет массив __webRtcConnectionsPool
			function setWebRtcConnectionsPool(offerSDP, type){
				if(type === "me"){
					if(__webRtcConnectionsPool.me === undefined)
						__webRtcConnectionsPool.me = offerSDP;
				}
				
				if(type === "remote"){
					if(__webRtcConnectionsPool.remote === undefined){
						__webRtcConnectionsPool.remote = {};
						__webRtcConnectionsPool.remote[0] = offerSDP;
					}else{
						__webRtcConnectionsPool.remote.push = offerSDP
					}
				}
			}
			
			//Обработчик на событие установленного соединения
			socket.on('handshake', function(data){
				//Устанавливаем идентификатор клиента
				if(__clientID === "")
					__clientID = data.clientCurrentNodeId;
			});
			
			//При истечении сесии (сейчас это связано только с рестартом сервера),
			//чтобы не обвалить сервер происходит отключение сокета.
			socket.on('reconnect', function(){
				console.log("session is out");
				console.log("need refersh page");
				console.log("socket connect disconnection");
				socket.disconnect();
			});
			
			socket.on("takeRemoteSdp", function(msg){
				console.log(msg);
				var parsedMessage = JSON.parse(msg.data);
				var sdpData = parsedMessage.sdpdata;
				console.log(msg.id);
				console.log(__clientID);
				console.log(sdpData);
				if(msg.id !== __clientID){
					if(sdpData.sdp){
						var remoteDescription = new RTCSessionDescription(sdpData);
						setWebRtcConnectionsPool(remoteDescription, "remote");
						peerConnection.setRemoteDescription(remoteDescription, function(){
							console.log("set remote and send answer");
							if(peerConnection.remoteDescription.type === "offer"){
								//Получили SDP, значит надо отправить ответ
								peerConnection.createAnswer(createOfferAnswerCallback, logError);
							}
						}, logError);
					}
				}else{
					console.log("ommiting");
				}
			});
			
			//Отправляем SDP через сокет соединение
			function sendSdpOthers(socket, peerConnection){
				socket.emit("takeSDP", JSON.stringify({"sdpdata" : peerConnection.localDescription}));
			}
			
			//Отправляем оффер
			//peerConnection.createOffer(createOfferAnswerCallback, logError);
			
			//Колбэк на отправку оффера/ответа
			function createOfferAnswerCallback(offerSDP){
				//Нулевой offerSDP всегда соответствует собственному sdp браузера (надо будет придумать другой ключ массива)
				setWebRtcConnectionsPool(offerSDP, "me");
				//Сначала устанавливаем локальные настройки канала
				peerConnection.setLocalDescription(offerSDP, function(){
					console.log("create offer and set local desciption");
					console.log(peerConnection.localDescription);
					
					//А вот здесь отправляем другому браузеру наши настройки
					sendSdpOthers(socket, peerConnection);
				}, logError);
			}
			
			function logError(error){
				console.log(error);
				console.log(error.name + ": " + error.message);
			}
			
			function offer(){
				peerConnection.createOffer(createOfferAnswerCallback, logError);
			}
		</script>
	</head>
	<button onclick="offer();">Offer</button>
	<body>
		index page
	</body>
</html>